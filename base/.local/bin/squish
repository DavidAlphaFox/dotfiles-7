#!/bin/zsh

echo -e "\n🗜️   Deduplicating filesystem..."
device="$(findmnt -nvo SOURCE /)"
mntpnt="$(mktemp -d --tmpdir duperemove-XXXXXX)"
mkdir -p $mntpnt
sudo mount $device $mntpnt
pushd -q $mntpnt
sudo duperemove -rdhv .

echo -e "\n🗜️   Rebalancing filesystem..."
sudo btrfs balance start -dusage=66 -musage=66 /mnt

popd -q
sudo umount $mntpnt
rmdir $mntpnt

echo -e "\n🗜️   Discarding unused blocks..."
sudo fstrim -av

