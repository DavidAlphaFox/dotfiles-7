#!/bin/zsh

# function to get available updates
get_updates() {
  ARCHUPDATES="$(checkupdates)"
  AURUPDATES="$(yaourt -Qua)"
  if [ -n "$ARCHUPDATES" ]; then
    echo -nE "${ARCHUPDATES}\\n"
  fi
  if [ -n "$AURUPDATES" ]; then
    echo -nE "${AURUPDATES}\\n"
  fi
}

if [ -z "$BLOCK_BUTTON" ]; then
  # wait 10s for login/reload/etc
  sleep 10
fi
UPDATES="$(get_updates)"

# right-click for upgrade
if [ "$BLOCK_BUTTON" = "3" ]; then
  if [ -n "$UPDATES" ]; then
    i3-sensible-terminal -e "zsh -ic 'dialog --title \"Updates\" --colors --yesno \"$(echo $UPDATES | paste -sd '|' | sed 's/|/\\\\n/g')Update packages?\" 0 0 && clear && yaourt -Syua && deorphan && yes | yaourt -Scc'"
  fi
fi

# send out the notification
if [ -n "$UPDATES" ]; then
  echo " $(echo $UPDATES | grep -c "-")"
  print "\n#99734d80\n"
  notify-info "Updates are available:" "$(echo $UPDATES)" -i software-update-available
else
  echo " 0"
  notify-info "The system is up-to-date" -i software-update-available
fi

exit 0
