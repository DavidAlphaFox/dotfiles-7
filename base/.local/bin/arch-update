#!/bin/zsh

# function to get available updates
get_updates() {
  ARCHUPDATES="$(checkupdates)"
  AURUPDATES="$(yaourt -Qua)"
  if [ -n "$ARCHUPDATES" ]; then
    echo -nE "\\Z2\Zb${ARCHUPDATES}\\n"
  fi
  if [ -n "$AURUPDATES" ]; then
    echo -nE "\\Z1\Zb${AURUPDATES}\\n"
  fi
  if [ -n "$ARCHUPDATES" -o -n "$AURUPDATES" ]; then
    echo -nE "\\Zn"
  fi
}

if [ "$BLOCK_BUTTON" = "3" ]; then
  # right-click for upgrade
  UPDATES="$(get_updates)"
  if [ -n "$UPDATES" ]; then
    i3-sensible-terminal -e "zsh -ic 'dialog --title \"Updates\" --colors --yesno \"$(echo $UPDATES | paste -sd '|' | sed 's/|/\\\\n/g')Update packages?\" 0 0 && clear && yaourt -Syua && deorphan && yes | yaourt -Scc'"
  fi
elif [ "$BLOCK_BUTTON" = "1" ]; then
  # left-click to check immediately
  UPDATES="$(get_updates)"
elif [ -z "$BLOCK_BUTTON" ]; then
  # otherwise, wait 10s for login/reload/etc
  sleep 10
  UPDATES="$(get_updates)"
fi
# send out the notification
if [ -n "$UPDATES" ]; then
  echo " $(echo $UPDATES | grep -c "")"
  print "\n#99734d80\n"
  notify-info "Updates are available:" "$(echo $UPDATES)" -i software-update-available
else
  echo " 0"
  notify-info "The system is up-to-date"
fi
exit 0
