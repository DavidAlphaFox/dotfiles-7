#!/bin/zsh

# update dotfiles
echo -e "ðŸšï¸   Updating dotfiles..."
cd ~/.dotfiles
git stash -q
git pull 
git stash pop
~/.dotfiles/base/.local/bin/restow

# upgrade all packages
echo -e "\nðŸ’¾  Updating system..."
yaourt -Syu --aur

# removed orphaned packages
orphans="$(yaourt -Qdtq)"
if [ -n "$orphans" ]; then
  echo -e "\nðŸ’©  Removing orphaned packages..."
  yaourt -Rns $(echo $orphans)
fi

# removed cached packages
if [ -n "$(find /var/cache/pacman/pkg -type f)" ]; then
  #dodedup=yes
  echo -e "\nðŸ—‘ï¸   Removing cached packages..."
  yes | sudo pacman -Scc 2>&1 >/dev/null
fi

# upgrade antgen plugins
echo -e "\nðŸ’‰  Updating antigen packages..."
source /usr/share/zsh/share/antigen.zsh
antigen update

# upgrade Atom packages
if hash apm 2>/dev/null; then
  echo -e "\nâš›ï¸   Updating Atom packages..."
  echo -e "$(apm upgrade --no-confirm 2>/dev/null)"
fi

# dedup btrfs
if [ -n "$dodedup" ]; then
  echo -e "\nðŸ—œï¸   Deduplicating filesystem..."
  device="$(findmnt -nvo SOURCE /)"
  mntpnt="$(mktemp -d --tmpdir duperemove-XXXXXX)"
  mkdir -p $mntpnt
  sudo mount $device $mntpnt
  pushd -q $mntpnt
  echo "$(sudo duperemove -rdh . 2>/dev/null | grep "net change")"
  popd -q
  sudo umount $mntpnt
  rmdir $mntpnt
fi

