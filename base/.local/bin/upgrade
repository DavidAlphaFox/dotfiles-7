#!/bin/zsh

# update dotfiles
echo -e "🏚️   Updating dotfiles..."
cd ~/.dotfiles
git stash -q
git pull 
git stash pop
~/.dotfiles/base/.local/bin/restow

# upgrade all packages
echo -e "\n💾  Updating system..."
yay -Syu

# removed orphaned packages
orphans="$(yay -Qdtq)"
if [ -n "$orphans" ]; then
  echo -e "\n💩  Removing orphaned packages..."
  yay -Rns $(echo $orphans)
fi

# removed cached packages
if [ -n "$(find /var/cache/pacman/pkg -type f)" ]; then
  #dodedup=yes
  echo -e "\n🗑️   Removing cached packages..."
  yes | sudo yay -Scc 2>&1 >/dev/null
fi

# upgrade antgen plugins
echo -e "\n💉  Updating antigen packages..."
source /usr/share/zsh/share/antigen.zsh
antigen update

# upgrade Atom packages
if hash apm 2>/dev/null; then
  echo -e "\n⚛️   Updating Atom packages..."
  echo -e "$(apm upgrade --no-confirm 2>/dev/null)"
fi

# dedup btrfs
if [ -n "$dodedup" ]; then
  echo -e "\n🗜️   Deduplicating filesystem..."
  device="$(findmnt -nvo SOURCE /)"
  mntpnt="$(mktemp -d --tmpdir duperemove-XXXXXX)"
  mkdir -p $mntpnt
  sudo mount $device $mntpnt
  pushd -q $mntpnt
  sudo duperemove -rdhv .
  popd -q
  sudo umount $mntpnt
  rmdir $mntpnt
fi

